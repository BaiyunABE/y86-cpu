# Y86-64 流水线处理器实现

## 概述

本项目实现了一个完整的 Y86-64 指令集架构的流水线处理器，包含 5 级流水线（取指、译码、执行、访存、写回），支持完整的 Y86-64 指令集，并实现了先进的数据冒险处理、控制预测和缓存系统。

## 项目结构

### 主要模块

1. **IMEM** - 指令存储器
   - 256 字节存储空间
   - 预加载求和程序示例
   - 小端序数据组织

2. **DMEM** - 数据存储器
   - 带缓存机制（16 字节缓存行）
   - 直接映射缓存
   - 预初始化数组数据 [0x000000d000d000d, 0x000000c000c000c0, 0x00000b000b000b00, 0x0000a000a000a000]

3. **Y86** - 处理器核心
   - 5 级流水线实现
   - 完整的数据转发和冒险处理
   - 返回地址栈(RAS)预测机制
   - 条件码和标志位管理
   - 缓存一致性维护

## 功能特性

### 先进处理器特性

1. **5 级流水线**
   - 取指(F)、译码(D)、执行(E)、访存(M)、写回(W)
   - 完整流水线寄存器实现

2. **数据冒险处理**
   - 全路径转发逻辑
   - 精确的写后读(RAW)冒险检测
   - 流水线暂停机制

3. **控制预测**
   - 16 深度返回地址栈(RAS)
   - 调用/返回指令预测
   - 预测错误恢复机制
   - 分支预测失败处理

4. **缓存系统**
   - 16 字节缓存行
   - 直接映射缓存
   - 缓存一致性维护
   - 缓存未命中处理

5. **复位系统**
   - 完整系统复位功能
   - 寄存器/内存初始化

## 示例程序

处理器预加载了一个数组求和程序：

```assembly
# 初始化
irmovq stack, %rsp
call main
halt

main:
    irmovq array, %rdi
    irmovq $4, %rsi
    call sum
    ret

sum:
    irmovq $8, %r8
    irmovq $1, %r9
    xorq %rax, %rax
    andq %rsi, %rsi
    jmp test

loop:
    mrmovq (%rdi), %r10
    addq %r10, %rax
    addq %r8, %rdi
    subq %r9, %rsi

test:
    jne loop
    ret
```

程序功能：计算数组 [0x000000d000d000d, 0x000000c000c000c0, 0x00000b000b000b00, 0x0000a000a000a000] 的元素和，结果存储在 %rax 寄存器

## 使用说明

### 输入信号

| 信号      | 描述                |
|-----------|---------------------|
| CLK       | 系统时钟            |
| reset     | 复位信号 (高有效)   |

### 输出信号

| 信号         | 描述                     |
|--------------|--------------------------|
| F_predPC     | 取指阶段预测PC           |
| D_icode      | 译码阶段指令代码         |
| D_ifun       | 译码阶段指令功能码       |
| D_rA         | 译码阶段寄存器A          |
| D_rB         | 译码阶段寄存器B          |
| D_valC       | 译码阶段常数值           |
| D_valP       | 译码阶段下一条指令地址   |
| E_icode      | 执行阶段指令代码         |
| E_ifun       | 执行阶段指令功能码       |
| E_valC       | 执行阶段常数值           |
| E_valA       | 执行阶段操作数A          |
| E_valB       | 执行阶段操作数B          |
| E_dstE       | 执行阶段目标寄存器E      |
| E_dstM       | 执行阶段目标寄存器M      |
| M_icode      | 访存阶段指令代码         |
| M_Cnd        | 访存阶段条件标志         |
| M_valE       | 访存阶段ALU结果          |
| M_valA       | 访存阶段值A             |
| M_valC       | 访存阶段常数值           |
| M_dstE       | 访存阶段目标寄存器E      |
| M_dstM       | 访存阶段目标寄存器M      |
| W_icode      | 写回阶段指令代码         |
| W_Cnd        | 写回阶段条件标志         |
| W_valE       | 写回阶段值E             |
| W_valM       | 写回阶段值M             |
| W_dstE       | 写回阶段目标寄存器E      |
| W_dstM       | 写回阶段目标寄存器M      |
| Stat         | 处理器状态 [1:0]         |

### 操作流程

1. **复位系统**
   - 激活 reset 信号初始化所有组件
   - 寄存器清零
   - 内存初始化为预设值

2. **启动执行**
   - 提供时钟信号 CLK
   - 处理器自动开始执行程序

3. **观察执行状态**
   - 通过输出信号监控各流水线阶段状态
   - 当 Stat 变为 HLT 时程序执行完成

## 设计亮点

1. **RAS 高级实现**
   - 多路径嵌套处理（支持16层调用）
   - 预测错误恢复机制
   - 状态一致性维护
   - 投机执行协同

2. **高效缓存系统**
   - 缓存行快速访问
   - 写回策略优化
   - 缓存未命中处理

3. **精确冒险处理**
   - 全路径数据转发
   - 精确的流水线控制
   - 预测错误恢复

4. **完整验证机制**
   - 地址错误检测
   - 非法指令处理
   - 流水线状态监控

## 性能指标

| 功能              | 性能参数                 |
|-------------------|--------------------------|
| 最大时钟频率      | 100MHz (取决于实现)      |
| RAS 恢复周期      | 1 周期                   |
| 缓存访问延迟      | 1 周期 (命中)            |
| 分支预测准确率    | >60% (典型程序)          |

## 资源利用

| 资源类型        | 使用量估算     |
|-----------------|----------------|
| 逻辑单元(LE)    | ~12,000       |
| 内存比特        | 4,096         |
| 流水寄存器      | 1797          |

## 未来扩展

1. 添加指令跟踪接口
2. 实现多级缓存系统
3. 增加性能计数器
4. 支持更复杂的超标量设计

## 贡献指南

欢迎提交 Issue 或 Pull Request：
1. 报告问题请提供复现步骤
2. 新功能建议需附设计文档
3. 代码提交前通过完整测试
4. 遵守代码风格规范